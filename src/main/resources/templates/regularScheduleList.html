<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title th:text="|定期スケジュール (${boardName})|">定期スケジュール</title>
</head>
<body>
<div class="container-fluid bg-light">
  <div class="d-flex align-items-center mb-1">
    <a href="/" class="btn btn-outline-secondary btn-sm me-3">← トップ</a>
    <h1 class="fs-3 mb-0" th:text="|定期スケジュール (${boardName})|">定期スケジュール</h1>
  </div>

  <!-- フィルター + 月別生成フォーム -->
  <form method="get" th:action="@{/edit_regular_schedules}" class="mb-2">
    <input type="hidden" name="boardId" th:value="${boardId}">
    <input type="hidden" name="filterActive" value="true">

    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <div class="form-check form-switch fs-5">
          <input class="form-check-input" id="filter-show-detail" type="checkbox"
                 name="showDetail" value="true" th:checked="${showDetail}"
                 data-bs-toggle="collapse" data-bs-target="#detail-filters">
          <label class="form-check-label" for="filter-show-detail">表示条件を詳細指定する</label>
        </div>
      </div>
    </div>

    <div th:class="${showDetail} ? 'collapse show' : 'collapse'" id="detail-filters">
      <div class="row g-2 align-items-center mt-1">
        <div class="col-auto">
          <div class="form-check form-check-inline">
            <input class="form-check-input" id="filter-am" type="checkbox"
                   name="showAm" value="true" th:checked="${showAm}">
            <label class="form-check-label" for="filter-am">AM</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" id="filter-pm" type="checkbox"
                   name="showPm" value="true" th:checked="${showPm}">
            <label class="form-check-label" for="filter-pm">PM</label>
          </div>
        </div>
      </div>
      <div class="row mt-1 g-2 align-items-center">
        <div class="col-auto">
          <span th:each="day,i : ${daysJp}" class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox"
                   th:id="'filter-dow-' + ${i.index}"
                   name="dow" th:value="${i.index}"
                   th:checked="${selectedDow.contains(i.index)}">
            <label class="form-check-label" th:for="'filter-dow-' + ${i.index}"
                   th:text="${day} + '曜'"></label>
          </span>
        </div>
        <div class="col-auto">
          <span th:each="w : ${#numbers.sequence(0, 4)}" class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox"
                   th:id="'filter-week-' + ${w}"
                   name="week" th:value="${w}"
                   th:checked="${selectedWeek.contains(w)}">
            <label class="form-check-label" th:for="'filter-week-' + ${w}"
                   th:text="${w + 1} + '週目'"></label>
          </span>
        </div>
      </div>
    </div>
  </form>
  <script>
    document.querySelectorAll('form[action] .form-check-input').forEach(cb =>
      cb.addEventListener('change', () => cb.closest('form').submit())
    );
  </script>

  <!-- スタッフ + 月別スケジュール作成 -->
  <div class="d-flex align-items-center gap-2 pb-2">
    <span class="fw-bold">スタッフ：</span>
    <span th:if="${!staffNicknames.isEmpty()}"
          th:text="${#strings.listJoin(staffNicknames, '、')}"></span>
    <span th:if="${staffNicknames.isEmpty()}" class="text-danger">スタッフを登録してください</span>
    <a th:href="@{/staff-maintenance(boardId=${boardId})}"
       th:class="${staffNicknames.isEmpty()}
         ? 'btn btn-primary btn-sm'
         : 'btn btn-outline-secondary btn-sm'">スタッフ管理</a>
    <form th:action="@{/schedule/{id}/createByMonthForm(id=${boardId})}" method="post"
          class="d-inline-flex gap-0 ms-auto">
      <input type="month" class="form-control" id="fromDate" name="fromDate" required
             style="border-radius:0.375rem 0 0 0.375rem; max-width:180px;">
      <button class="btn btn-primary text-nowrap" type="submit"
              th:disabled="${staffNicknames.isEmpty()}"
              style="border-radius:0 0.375rem 0.375rem 0;">月別スケジュール作成</button>
    </form>
  </div>
</div>

<!-- スケジュールテーブル -->
<table class="table table-cellhover table-cellhover-cyan" id="schedule-table">
  <th:block th:each="s : ${schedules}">
    <thead>
      <tr>
        <th class="fs-5 bg-dark bg-gradient text-light" style="width:7em">
          <span th:text="|第${s.week + 1}${daysJp[s.dayOfWeek]}曜|"></span>
          <i class="fa fa-print" style="cursor:pointer"
             th:attr="onclick='openReport(' + ${s.id} + ')'"></i>
        </th>
        <th th:each="work : ${s.works}" class="fs-6 bg-dark bg-gradient text-light" th:text="${work.name}"></th>
      </tr>
    </thead>
    <tbody>
      <!-- AM行 -->
      <tr th:if="${showAm}">
        <th class="table-secondary"><div class="fs-6">AM</div></th>
        <td th:each="work,wi : ${s.works}"
            ondblclick="editCell(event)"
            th:data-sid="${s.id}" th:data-widx="${wi.index}" data-tidx="0">
          <pre class="cut cell-text" th:text="${work.tasks.get(0).taskContents}"></pre>
        </td>
      </tr>
      <!-- PM行 -->
      <tr th:if="${showPm}">
        <th class="table-secondary"><div class="fs-6">PM</div></th>
        <td th:each="work,wi : ${s.works}"
            ondblclick="editCell(event)"
            th:data-sid="${s.id}" th:data-widx="${wi.index}" data-tidx="1">
          <pre class="cut cell-text" th:text="${work.tasks.get(1).taskContents}"></pre>
        </td>
      </tr>
    </tbody>
  </th:block>
</table>

<!-- エラートースト -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1100">
  <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="errorToastMsg"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const BOARD_ID = /*[[${boardId}]]*/ 0;
  const SHOW_AM  = /*[[${showAm}]]*/ true;
  const SHOW_PM  = /*[[${showPm}]]*/ true;
  const schedulesJson = /*[[${schedulesJson}]]*/ '[]';
  const schedules = JSON.parse(schedulesJson);

  // 翌月をデフォルト設定
  (function() {
    const next = new Date();
    next.setMonth(next.getMonth() + 1);
    const mm = String(next.getMonth() + 1).padStart(2, '0');
    document.getElementById('fromDate').value = next.getFullYear() + '-' + mm;
  })();

  function showErrorToast(msg) {
    const el = document.getElementById('errorToast');
    document.getElementById('errorToastMsg').textContent = msg;
    bootstrap.Toast.getOrCreateInstance(el, { autohide: false }).show();
  }

  // サーバーバリデーションエラーをトースト表示
  const toastError = /*[[${toastError}]]*/ null;
  if (toastError) showErrorToast(toastError);
</script>
<script th:src="@{/js/regularSchedule.js}"></script>
</body>
</html>
