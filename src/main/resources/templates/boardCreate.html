<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>ボード追加</title>
  <style>
    body { font-family: "BIZ UDPGothic", "Yu Gothic", YuGothic, sans-serif; }

    .route-item {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .route-input {
      width: 120px;
      min-width: 80px;
      text-align: center;
      border-radius: 0.375rem 0 0 0.375rem;
      border-right: none;
    }

    .route-item:only-child .route-delete-btn,
    .route-item.first-route .route-delete-btn {
      display: none;
    }

    /* 1件目のとき × がないので右端を丸める */
    .route-item.first-route .route-input {
      border-radius: 0.375rem;
      border-right: 1px solid #ced4da;
    }

    .toast-container { z-index: 1100; }
  </style>
</head>
<body>
<div class="container mt-3" style="max-width: 720px;">

  <!-- ヘッダー -->
  <div class="d-flex align-items-center mb-4">
    <a href="/" class="btn btn-outline-secondary btn-sm me-3">← トップ</a>
    <h1 class="h4 mb-0">ボード追加</h1>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">

      <!-- ボードID -->
      <div class="mb-3">
        <label for="boardId" class="form-label fw-bold">ボードID <span class="text-danger">*</span></label>
        <input type="number" class="form-control" id="boardId" style="max-width:160px;"
               placeholder="例: 1" min="0">
        <div class="form-text">整数で指定してください。既存IDと重複すると登録できません。</div>
      </div>

      <!-- ボード名 -->
      <div class="mb-4">
        <label for="boardName" class="form-label fw-bold">ボード名 <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="boardName" style="max-width:320px;"
               placeholder="例: Aチーム">
      </div>

      <!-- ルート設定 -->
      <div class="mb-4">
        <label class="form-label fw-bold">ルート設定</label>
        <div id="routeList" class="d-flex flex-wrap gap-2 align-items-center border rounded p-3 bg-light">
          <!-- JS で描画 -->
        </div>
        <div class="mt-2">
          <button type="button" class="btn btn-outline-success btn-sm" onclick="addRoute()">
            ＋ ルート追加
          </button>
        </div>
      </div>

    </div>
    <div class="card-footer d-flex justify-content-end">
      <button type="button" class="btn btn-primary px-4" onclick="submitCreate()">
        登録する
      </button>
    </div>
  </div>

</div>

<!-- トースト -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="resultToast" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg"></div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
const DEFAULT_ROUTES = ['内勤', 'ルートA', 'ルートB', 'ルートC'];
let routes = [...DEFAULT_ROUTES];

renderRoutes();

function renderRoutes() {
  const container = document.getElementById('routeList');
  container.innerHTML = '';
  routes.forEach((name, idx) => {
    container.appendChild(createRouteItem(name, idx));
  });
}

function createRouteItem(name, idx) {
  const isFirst = idx === 0;
  const wrapper = document.createElement('div');
  wrapper.className = 'route-item' + (isFirst ? ' first-route' : '');

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'form-control form-control-sm route-input';
  input.value = name;
  input.oninput = () => { routes[idx] = input.value; };

  wrapper.appendChild(input);

  if (!isFirst) {
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'btn btn-outline-danger btn-sm route-delete-btn';
    delBtn.style.cssText = 'border-radius:0 0.375rem 0.375rem 0; border-left:none;';
    delBtn.innerHTML = '&times;';
    delBtn.title = '削除';
    delBtn.onclick = () => {
      routes.splice(idx, 1);
      renderRoutes();
    };
    wrapper.appendChild(delBtn);
  }

  return wrapper;
}

function addRoute() {
  routes.push('');
  renderRoutes();
  const inputs = document.querySelectorAll('.route-input');
  if (inputs.length > 0) {
    inputs[inputs.length - 1].focus();
  }
}

function submitCreate() {
  document.querySelectorAll('.route-input').forEach((input, idx) => {
    routes[idx] = input.value;
  });

  const boardIdVal = document.getElementById('boardId').value.trim();
  const boardNameVal = document.getElementById('boardName').value.trim();
  const routesVal = routes.map(r => r.trim()).filter(r => r !== '');

  if (!boardIdVal) { showToast('ボードIDを入力してください', 'danger'); return; }
  if (!boardNameVal) { showToast('ボード名を入力してください', 'danger'); return; }
  if (routesVal.length === 0) { showToast('ルートを1件以上入力してください', 'danger'); return; }

  const submitBtn = document.querySelector('.btn-primary');
  submitBtn.disabled = true;
  submitBtn.textContent = '登録中…';

  fetch('/board/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      boardId: parseInt(boardIdVal, 10),
      boardName: boardNameVal,
      routes: routesVal
    })
  })
  .then(res => {
    if (res.status === 409) return res.json().then(j => { throw new Error(j.error || 'IDが重複しています'); });
    if (!res.ok) throw new Error('登録に失敗しました');
    return res.json();
  })
  .then(data => {
    if (window.confirm(boardNameVal + 'を登録しました。\n続けてスタッフを登録してください。')) {
      window.location.href = '/staff-maintenance?boardId=' + data.boardId;
    }
  })
  .catch(err => {
    showToast(err.message, 'danger');
    submitBtn.disabled = false;
    submitBtn.textContent = '登録する';
  });
}

function showToast(msg, type) {
  const toast = document.getElementById('resultToast');
  toast.className = 'toast align-items-center border-0 text-bg-' + type;
  document.getElementById('toastMsg').textContent = msg;
  const opts = type === 'danger' ? { autohide: false } : { autohide: true, delay: 3000 };
  bootstrap.Toast.getInstance(toast)?.dispose();
  bootstrap.Toast.getOrCreateInstance(toast, opts).show();
}
</script>
</body>
</html>
