<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title th:text="|月別スケジュール (${year}/${month})|">月別スケジュール</title>
</head>
<body>
<div class="container-fluid bg-light">
  <div class="d-flex align-items-center mb-1">
    <a href="/" class="btn btn-outline-secondary btn-sm me-3">← トップ</a>
    <h1 class="fs-3 mb-0" th:text="|月別スケジュール (${year}/${month})|">月別スケジュール</h1>
  </div>

  <!-- フィルターフォーム -->
  <form method="get" th:action="@{/schedule}" class="mb-2">
    <input type="hidden" name="boardId" th:value="${boardId}">
    <input type="hidden" name="targetMonth" th:value="${targetMonth}">
    <input type="hidden" name="filterActive" value="true">

    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <div class="form-check form-switch fs-5">
          <input class="form-check-input" id="filter-past-day" type="checkbox"
                 name="showPastDay" value="true" th:checked="${showPastDay}">
          <label class="form-check-label" for="filter-past-day">過去日を表示する</label>
        </div>
      </div>
      <div class="col-auto">
        <div class="form-check form-switch fs-5">
          <input class="form-check-input" id="filter-show-detail" type="checkbox"
                 name="showDetail" value="true" th:checked="${showDetail}"
                 data-bs-toggle="collapse" data-bs-target="#detail-filters">
          <label class="form-check-label" for="filter-show-detail">表示条件を詳細指定する</label>
        </div>
      </div>
    </div>

    <div th:class="${showDetail} ? 'collapse show' : 'collapse'" id="detail-filters">
      <div class="row g-2 align-items-center mt-1">
        <div class="col-auto">
          <div class="form-check form-check-inline">
            <input class="form-check-input" id="filter-am" type="checkbox"
                   name="showAm" value="true" th:checked="${showAm}">
            <label class="form-check-label" for="filter-am">AM</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" id="filter-pm" type="checkbox"
                   name="showPm" value="true" th:checked="${showPm}">
            <label class="form-check-label" for="filter-pm">PM</label>
          </div>
        </div>
      </div>
      <div class="row mt-1 g-2 align-items-center">
        <div class="col-auto">
          <span th:each="day,i : ${daysJp}" class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox"
                   th:id="'filter-dow-' + ${i.index}"
                   name="dow" th:value="${i.index}"
                   th:checked="${selectedDow.contains(i.index)}">
            <label class="form-check-label" th:for="'filter-dow-' + ${i.index}"
                   th:text="${day} + '曜'"></label>
          </span>
        </div>
        <div class="col-auto">
          <span th:each="w : ${#numbers.sequence(0, 4)}" class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox"
                   th:id="'filter-week-' + ${w}"
                   name="week" th:value="${w}"
                   th:checked="${selectedWeek.contains(w)}">
            <label class="form-check-label" th:for="'filter-week-' + ${w}"
                   th:text="${w + 1} + '週目'"></label>
          </span>
        </div>
      </div>
    </div>
  </form>
  <script>
    document.querySelectorAll('form[action] .form-check-input').forEach(cb =>
      cb.addEventListener('change', () => cb.closest('form').submit())
    );
  </script>
</div>

<!-- スケジュールテーブル -->
<table class="table table-cellhover" id="schedule-table">
  <th:block th:each="s : ${schedules}">
    <thead>
      <tr>
        <th class="fs-5 bg-success bg-gradient text-light" style="width:7em">
          <span th:text="|${s.scheduleDate.monthValue}/${s.scheduleDate.dayOfMonth}(${daysJp[s.dayOfWeek]})|"></span>
          <i class="fa fa-print" style="cursor:pointer"
             th:attr="onclick='openDailyReport(' + ${s.id} + ')'"></i>
        </th>
        <th th:each="work : ${s.works}" class="fs-6 bg-success bg-gradient text-light" th:text="${work.name}"></th>
      </tr>
    </thead>
    <tbody>
      <!-- AM行 -->
      <tr th:if="${showAm}">
        <th class="table-secondary"
            th:data-sid="${s.id}" data-slot="AM" data-widx="pool"
            ondragover="event.preventDefault()" ondrop="dropStaff(event)">
          <div class="fs-6">AM</div>
          <div th:if="${!s.staffs.isEmpty()}">
            <span th:each="staff : ${s.staffs.get(0)}"
                  class="badge rounded-pill bg-warning text-dark fs-6 m-1"
                  draggable="true"
                  th:data-sid="${s.id}" data-slot="AM" data-widx="pool"
                  th:data-nickname="${staff.nickname}"
                  ondragstart="dragStaff(event)">
              <span th:text="${staff.nickname}"></span>
            </span>
          </div>
        </th>
        <td th:each="work,wi : ${s.works}"
            ondblclick="editCell(event)"
            th:data-sid="${s.id}" th:data-widx="${wi.index}" data-tidx="0" data-slot="AM"
            ondragover="event.preventDefault()" ondrop="dropStaff(event)">
          <div>
            <span th:each="staff : ${work.tasks.get(0).staffs}"
                  class="badge rounded-pill bg-warning text-dark fs-6 m-1"
                  draggable="true"
                  th:data-sid="${s.id}" th:data-widx="${wi.index}" data-slot="AM"
                  th:data-nickname="${staff.nickname}"
                  ondragstart="dragStaff(event)">
              <span th:text="${staff.nickname}"></span>
            </span>
          </div>
          <pre class="cut cell-text" th:text="${work.tasks.get(0).taskContents}"></pre>
        </td>
      </tr>
      <!-- PM行 -->
      <tr th:if="${showPm}">
        <th class="table-secondary"
            th:data-sid="${s.id}" data-slot="PM" data-widx="pool"
            ondragover="event.preventDefault()" ondrop="dropStaff(event)">
          <div class="fs-6">PM</div>
          <div th:if="${s.staffs.size() > 1}">
            <span th:each="staff : ${s.staffs.get(1)}"
                  class="badge rounded-pill bg-info text-dark fs-6 m-1"
                  draggable="true"
                  th:data-sid="${s.id}" data-slot="PM" data-widx="pool"
                  th:data-nickname="${staff.nickname}"
                  ondragstart="dragStaff(event)">
              <span th:text="${staff.nickname}"></span>
            </span>
          </div>
        </th>
        <td th:each="work,wi : ${s.works}"
            ondblclick="editCell(event)"
            th:data-sid="${s.id}" th:data-widx="${wi.index}" data-tidx="1" data-slot="PM"
            ondragover="event.preventDefault()" ondrop="dropStaff(event)">
          <div>
            <span th:each="staff : ${work.tasks.get(1).staffs}"
                  class="badge rounded-pill bg-info text-dark fs-6 m-1"
                  draggable="true"
                  th:data-sid="${s.id}" th:data-widx="${wi.index}" data-slot="PM"
                  th:data-nickname="${staff.nickname}"
                  ondragstart="dragStaff(event)">
              <span th:text="${staff.nickname}"></span>
            </span>
          </div>
          <pre class="cut cell-text" th:text="${work.tasks.get(1).taskContents}"></pre>
        </td>
      </tr>
    </tbody>
  </th:block>
</table>

<!-- エラートースト -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1100">
  <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="errorToastMsg"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const BOARD_ID    = /*[[${boardId}]]*/ 0;
  const TARGET_MONTH = /*[[${targetMonth}]]*/ '';
  const SHOW_AM     = /*[[${showAm}]]*/ true;
  const SHOW_PM     = /*[[${showPm}]]*/ true;
  const schedulesJson = /*[[${schedulesJson}]]*/ '[]';
  const schedules = JSON.parse(schedulesJson);

  function showErrorToast(msg) {
    const el = document.getElementById('errorToast');
    document.getElementById('errorToastMsg').textContent = msg;
    bootstrap.Toast.getOrCreateInstance(el, { autohide: false }).show();
  }
</script>
<script th:src="@{/js/schedule.js}"></script>
</body>
</html>
