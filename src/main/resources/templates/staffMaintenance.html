<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>スタッフ管理</title>
  <style>
    body { font-family: "BIZ UDPGothic", "Yu Gothic", YuGothic, sans-serif; }

    #staffList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .staff-item {
      display: flex;
      align-items: center;
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #dee2e6;
      gap: 0.5rem;
    }
    .staff-item:last-child { border-bottom: none; }
    .staff-item:hover { background-color: #f8f9fa; }

    .staff-num {
      width: 2rem;
      color: #adb5bd;
      font-size: 0.85rem;
      text-align: right;
      flex-shrink: 0;
    }

    .staff-name-text {
      flex: 1;
      font-size: 1rem;
      cursor: pointer;
    }

    .staff-name-input {
      flex: 1;
      display: none;
    }

    .staff-item.editing .staff-name-text { display: none; }
    .staff-item.editing .staff-name-input { display: block; }

    .drag-handle {
      cursor: grab;
      color: #ced4da;
      flex-shrink: 0;
      user-select: none;
    }
    .drag-handle:active { cursor: grabbing; }

    .staff-item.drag-over {
      border-top: 2px solid #0d6efd;
    }

    #addArea { background-color: #f8f9fa; }

    .toast-container { z-index: 1100; }
  </style>
</head>
<body>
<div class="container mt-3" style="max-width: 640px;">

  <!-- ヘッダー -->
  <div class="d-flex align-items-center mb-4">
    <a href="/" class="btn btn-outline-secondary btn-sm me-3">← トップ</a>
    <h1 class="h4 mb-0">スタッフ管理</h1>
  </div>

  <!-- ボード選択 -->
  <div class="mb-4">
    <label for="boardSelector" class="form-label fw-bold">チーム選択</label>
    <select class="form-select" id="boardSelector" onchange="changeBoard(this.value)">
      <option th:each="board : ${boards}"
              th:value="${board.boardId}"
              th:text="${board.boardName}"
              th:selected="${currentBoard != null && board.boardId == currentBoard.boardId}">
        チーム名
      </option>
    </select>
  </div>

  <!-- スタッフリストカード -->
  <div th:if="${currentBoard != null}" class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        スタッフ一覧
        <span class="badge bg-secondary ms-1" id="staffCount">0</span>
      </div>
      <button class="btn btn-primary btn-sm px-3" onclick="saveStaffs()">
        保存
      </button>
    </div>

    <!-- リスト本体 -->
    <div class="card-body p-0">
      <ul id="staffList">
        <!-- JS で描画 -->
      </ul>
      <div id="emptyMsg" class="text-center text-muted py-4" style="display:none;">
        スタッフが登録されていません
      </div>
    </div>

    <!-- 追加エリア -->
    <div class="card-footer" id="addArea">
      <div class="input-group">
        <input type="text" class="form-control" id="newStaffName"
               placeholder="スタッフ名を入力して Enter"
               onkeydown="if(event.key==='Enter'){ event.preventDefault(); addStaff(); }">
        <button class="btn btn-success" type="button" onclick="addStaff()">
          ＋ 追加
        </button>
      </div>
    </div>
  </div>

  <!-- ボードなし -->
  <div th:if="${currentBoard == null}" class="alert alert-warning">
    ボードが存在しません。
  </div>

</div>

<!-- トースト -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="resultToast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg">保存しました</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script th:inline="javascript" th:if="${currentBoard != null}">
/*<![CDATA[*/
const boardId = /*[[${currentBoard.boardId}]]*/ 0;
let staffList = /*[[${staffNicknames}]]*/ [];

// ---- 初期描画 ----
renderList();

// ---- リスト描画 ----
function renderList() {
  const ul = document.getElementById('staffList');
  ul.innerHTML = '';
  staffList.forEach((name, idx) => {
    ul.appendChild(createItem(name, idx));
  });
  updateCount();
  document.getElementById('emptyMsg').style.display = staffList.length === 0 ? 'block' : 'none';
}

function createItem(name, idx) {
  const li = document.createElement('li');
  li.className = 'staff-item';
  li.draggable = true;
  li.dataset.idx = idx;

  // ドラッグハンドル
  const handle = document.createElement('span');
  handle.className = 'drag-handle';
  handle.innerHTML = '&#9776;';
  handle.title = 'ドラッグして並び替え';

  // 番号
  const num = document.createElement('span');
  num.className = 'staff-num';
  num.textContent = idx + 1;

  // 名前テキスト (クリックで編集)
  const nameText = document.createElement('span');
  nameText.className = 'staff-name-text';
  nameText.textContent = name;
  nameText.title = 'クリックして編集';
  nameText.onclick = () => startEdit(li, nameInput, nameText);

  // 名前入力
  const nameInput = document.createElement('input');
  nameInput.type = 'text';
  nameInput.className = 'form-control form-control-sm staff-name-input';
  nameInput.value = name;
  nameInput.onblur = () => finishEdit(li, nameInput, nameText, idx);
  nameInput.onkeydown = (e) => {
    if (e.key === 'Enter') { e.preventDefault(); nameInput.blur(); }
    if (e.key === 'Escape') { nameInput.value = staffList[idx]; nameInput.blur(); }
  };

  // 削除ボタン
  const delBtn = document.createElement('button');
  delBtn.type = 'button';
  delBtn.className = 'btn btn-outline-danger btn-sm';
  delBtn.innerHTML = '&#10005;';
  delBtn.title = '削除';
  delBtn.onclick = () => deleteItem(idx);

  // ドラッグ&ドロップ
  li.ondragstart = (e) => {
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', idx);
    li.style.opacity = '0.4';
  };
  li.ondragend = () => { li.style.opacity = ''; clearDragOver(); };
  li.ondragover = (e) => { e.preventDefault(); li.classList.add('drag-over'); };
  li.ondragleave = () => li.classList.remove('drag-over');
  li.ondrop = (e) => {
    e.preventDefault();
    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
    const toIdx = parseInt(li.dataset.idx);
    if (fromIdx !== toIdx) {
      const moved = staffList.splice(fromIdx, 1)[0];
      staffList.splice(toIdx, 0, moved);
      renderList();
    }
  };

  li.appendChild(handle);
  li.appendChild(num);
  li.appendChild(nameText);
  li.appendChild(nameInput);
  li.appendChild(delBtn);
  return li;
}

function startEdit(li, input, text) {
  li.classList.add('editing');
  input.focus();
  input.select();
}

function finishEdit(li, input, text, idx) {
  const newName = input.value.trim();
  if (newName) {
    staffList[idx] = newName;
  }
  li.classList.remove('editing');
  renderList();
}

function deleteItem(idx) {
  staffList.splice(idx, 1);
  renderList();
}

function clearDragOver() {
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function updateCount() {
  document.getElementById('staffCount').textContent = staffList.length;
}

// ---- 追加 ----
function addStaff() {
  const input = document.getElementById('newStaffName');
  const name = input.value.trim();
  if (!name) { input.focus(); return; }
  staffList.push(name);
  renderList();
  input.value = '';
  input.focus();
  // 追加後に一番下へスクロール
  const ul = document.getElementById('staffList');
  if (ul.lastChild) ul.lastChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ---- 保存 ----
function saveStaffs() {
  const saveBtn = document.querySelector('.btn-primary');
  saveBtn.disabled = true;
  saveBtn.textContent = '保存中…';

  fetch('/staff/' + boardId + '/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ staffs: staffList })
  })
  .then(res => {
    if (!res.ok) throw new Error('保存に失敗しました');
    return res.json();
  })
  .then(data => {
    showToast('保存しました（' + data.count + '名）', 'success');
  })
  .catch(err => {
    showToast(err.message, 'danger');
  })
  .finally(() => {
    saveBtn.disabled = false;
    saveBtn.textContent = '保存';
  });
}

// ---- ボード切替 ----
function changeBoard(newBoardId) {
  window.location.href = '/staff-maintenance?boardId=' + newBoardId;
}

// ---- トースト表示 ----
function showToast(msg, type) {
  const toast = document.getElementById('resultToast');
  toast.className = 'toast align-items-center border-0 text-bg-' + type;
  document.getElementById('toastMsg').textContent = msg;
  const opts = type === 'danger' ? { autohide: false } : { autohide: true, delay: 3000 };
  bootstrap.Toast.getInstance(toast)?.dispose();
  bootstrap.Toast.getOrCreateInstance(toast, opts).show();
}
/*]]>*/
</script>
</body>
</html>
